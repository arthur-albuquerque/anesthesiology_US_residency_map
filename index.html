<!DOCTYPE html>
<html>
<head>
    <title>Hospital Residency Map with Filters</title>
    <!-- Include Leaflet CSS and JS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Include PapaParse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content-wrapper {
            background-color: #fff;
            border-radius: 5px;
            padding: 10px;
        }
        .leaflet-popup-content {
            font-size: 14px;
            color: #333;
        }
        .leaflet-popup-tip {
            background-color: #fff;
        }
        .highlight {
            color: #ff4500; /* Orange-red for highlighting */
        }
        #filter-form {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        #filter-form label {
            margin-right: 5px;
            font-weight: bold;
        }
        #filter-form input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100px;
        }
        #filter-form button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #filter-form button:hover {
            background-color: #45a049;
        }
        #filter-form #clear-filters {
            background-color: #f44336;
        }
        #filter-form #clear-filters:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <h1>Hospital Residency Options with Filters</h1>
    <div id="filter-form">
        <div>
            <label for="step2ck-filter">Step 2CK Min (≥):</label>
            <input type="number" id="step2ck-filter" placeholder="e.g., 220">
        </div>
        <div>
            <label for="img-filter">IMG (≥):</label>
            <input type="number" id="img-filter" placeholder="e.g., 10">
        </div>
        <div>
            <label for="female-filter">Female Residents (≥):</label>
            <input type="number" id="female-filter" placeholder="e.g., 20">
        </div>
        <div>
            <label for="wage-filter">Wage PGY1 (≥):</label>
            <input type="number" id="wage-filter" placeholder="e.g., 60000">
        </div>
        <button onclick="applyFilters()">Apply Filters</button>
        <button id="clear-filters" onclick="clearFilters()">Clear Filters</button>
    </div>
    <div id="map"></div>

    <script>
        // Initialize the map, centered on the US
        var map = L.map('map').setView([39.8283, -98.5795], 4);
        var highlightedMarker = null;
        var markers = {};
        var hospitalData = [];

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        // Load and parse the CSV file
        Papa.parse('https://raw.githubusercontent.com/arthur-albuquerque/anesthesiology_US_residency_map/refs/heads/main/data.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
    transform: (value, header) => value.trim().replace(/^"|"$/g, ''),
    complete: (results) => {
        console.log("CSV loaded successfully:", results.data);
        hospitalData = results.data;
        displayMarkers(hospitalData);
    },
    error: (err) => {
        console.error("Error parsing CSV:", err);
        alert("Failed to load CSV data. Check the console for details.");
    }
});

        // Function to display markers based on the provided data
        function displayMarkers(hospitals) {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            hospitals.forEach(function(hospital) {
                var lat = parseFloat(hospital['Geocodio Latitude']);
                var lng = parseFloat(hospital['Geocodio Longitude']);

                // Only add marker if latitude and longitude are valid
                if (!isNaN(lat) && !isNaN(lng)) {
                    var popupContent = `<b>${hospital.Program}</b><br>` +
                                       `Step 2CK Min: ${hospital['Step 2CK min'] || 'N/A'}<br>` +
                                       `# IMG: ${hospital.IMG || 'N/A'}<br>` +
                                       `Female Residents: ${hospital.Female || 'N/A'}<br>` +
                                       `Wage PGY1: $${hospital['wage PGY1'] || 'N/A'}<br>` +
                                       `<button onclick="highlightLocation('${hospital.Program}', [${lat}, ${lng}])">Highlight Location</button>`;

                    var marker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(popupContent)
                        .bindTooltip(hospital.Program, { permanent: false, direction: 'top' });
                    markers[hospital.Program] = marker;
                }
            });
        }

        // Function to apply filters
        function applyFilters() {
            var step2ckFilter = parseFloat(document.getElementById('step2ck-filter').value) || -Infinity;
            var imgFilter = parseFloat(document.getElementById('img-filter').value) || -Infinity;
            var femaleFilter = parseFloat(document.getElementById('female-filter').value) || -Infinity;
            var wageFilter = parseFloat(document.getElementById('wage-filter').value) || -Infinity;

            var filteredHospitals = hospitalData.filter(hospital => {
                var step2ck = parseFloat(hospital['Step 2CK min']) || -Infinity;
                var img = parseFloat(hospital.IMG) || -Infinity;
                var female = parseFloat(hospital.Female) || -Infinity;
                var wage = parseFloat(hospital['wage PGY1']) || -Infinity;

                return step2ck >= step2ckFilter &&
                       img >= imgFilter &&
                       female >= femaleFilter &&
                       wage >= wageFilter;
            });

            displayMarkers(filteredHospitals);
        }

        // Function to clear filters
        function clearFilters() {
            document.getElementById('step2ck-filter').value = '';
            document.getElementById('img-filter').value = '';
            document.getElementById('female-filter').value = '';
            document.getElementById('wage-filter').value = '';
            displayMarkers(hospitalData);
        }

        // Function to highlight the selected location
        window.highlightLocation = function(program, coords) {
            if (highlightedMarker) {
                highlightedMarker.setIcon(L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                }));
            }
            highlightedMarker = markers[program];
            if (highlightedMarker) {
                highlightedMarker.setIcon(L.icon({
                    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                }));
                map.setView(coords, 12); // Zoom to location
            }
        };
    </script>
</body>
</html>
